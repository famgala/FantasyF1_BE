name: CI/CD Pipeline

on:
  push:
    branches: 
      - main
      - 'test/**'
      - 'dev/**'
  pull_request:
    branches: [ main, 'test/**' ]

env:
  REGISTRY: docker.io
  BACKEND_IMAGE_NAME: famgala/fantasyf1-be
  FRONTEND_IMAGE_NAME: famgala/fantasyf1-fe

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      backend_changed: ${{ steps.changes.outputs.backend }}
      dockerfile_changed: ${{ steps.changes.outputs.dockerfile }}
      compose_changed: ${{ steps.changes.outputs.compose }}
      tests_changed: ${{ steps.changes.outputs.tests }}
      workflow_changed: ${{ steps.changes.outputs.workflow }}
      frontend_changed: ${{ steps.changes.outputs.frontend }}
      frontend_config_changed: ${{ steps.changes.outputs.frontend_config }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Detect file changes
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            backend:
              - 'FantasyF1_BE/**'
              - '!FantasyF1_BE/tests/**'
              - 'FantasyF1_BE/requirements.txt'
            dockerfile:
              - 'Dockerfile*'
              - 'FantasyF1_BE/Dockerfile*'
            compose:
              - 'docker-compose*.yml'
            tests:
              - 'FantasyF1_BE/tests/**'
            workflow:
              - '.github/workflows/**'
            frontend:
              - 'frontend/src/**'
              - 'frontend/public/**'
            frontend_config:
              - 'frontend/package.json'
              - 'frontend/package-lock.json'
              - 'frontend/tsconfig*.json'
              - 'frontend/vite.config.ts'
              - 'frontend/eslint.config.js'
              - 'frontend/index.html'

  # Backend Tests
  test-backend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.backend_changed == 'true' || 
       needs.detect-changes.outputs.tests_changed == 'true' ||
       needs.detect-changes.outputs.workflow_changed == 'true' ||
       needs.detect-changes.outputs.dockerfile_changed == 'true' ||
       needs.detect-changes.outputs.compose_changed == 'true')
    
    permissions:
      contents: read
    
    env:
      SECRET_KEY: test_secret_key_for_ci_cd_only_change_in_production_1234567890abcdef
      JWT_SECRET_KEY: test_jwt_secret_key_for_ci_cd_only_change_in_production_1234567890abcdef
      POSTGRES_DB: test_fantasyf1_db
      POSTGRES_USER: test_fantasyf1_user
      POSTGRES_PASSWORD: test_password_ci_cd_2024
      REDIS_PASSWORD: test_redis_password_ci_cd_2024
      MQTT_USERNAME: test_mqtt_user
      MQTT_PASSWORD: test_mqtt_password_ci
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}

    - name: Build backend image locally for testing
      run: |
        echo "ğŸ”¨ Building backend image locally for CI/CD testing..."
        
        # Build the image
        docker build -t famgala/fantasyf1-be:dev FantasyF1_BE/ || {
          echo "âŒ Build failed"
          exit 1
        }
        
        echo "âœ… Backend image built successfully"
    
    - name: Create .env file for docker-compose
      run: |
        echo "ğŸš€ Creating .env file for docker-compose.test.yml..."
        
        # Create .env file with CI configuration
        echo "SECRET_KEY=test_secret_key_for_ci_cd_only_change_in_production_1234567890abcdef" > .env
        echo "JWT_SECRET_KEY=test_jwt_secret_key_for_ci_cd_only_change_in_production_1234567890abcdef" >> .env
        echo "JWT_ACCESS_TOKEN_EXPIRE_MINUTES=30" >> .env
        echo "JWT_REFRESH_TOKEN_EXPIRE_DAYS=7" >> .env
        echo "DATABASE_URL=postgresql+asyncpg://test_fantasyf1_user:test_password_ci_cd_2024@postgres:5432/test_fantasyf1_db" >> .env
        echo "POSTGRES_DB=test_fantasyf1_db" >> .env
        echo "POSTGRES_USER=test_fantasyf1_user" >> .env
        echo "POSTGRES_PASSWORD=test_password_ci_cd_2024" >> .env
        echo "MQTT_BROKER_HOST=mosquitto" >> .env
        echo "MQTT_BROKER_PORT=1883" >> .env
        echo "MQTT_USERNAME=test_mqtt_user" >> .env
        echo "MQTT_PASSWORD=test_mqtt_password_ci" >> .env
        echo "REDIS_PASSWORD=test_redis_password_ci_cd_2024" >> .env
        echo "REDIS_URL=redis://:test_redis_password_ci_cd_2024@redis:6379/0" >> .env
        echo "ENVIRONMENT=testing" >> .env
        echo "DEBUG=false" >> .env
        echo "CORS_ORIGINS=http://localhost:3000,http://localhost:8000" >> .env
        
        echo "âœ… .env file created successfully"
    
    - name: Start services with docker-compose
      run: |
        echo "ğŸš€ Starting services with docker-compose.test.yml..."
        
        # Start services using docker-compose
        docker compose -f docker-compose.test.yml up -d
        
        echo "âœ… Services started with docker-compose"
    
    - name: Wait for services to be ready
      run: |
        echo "Waiting for services to be healthy..."
        
        # Display container status
        echo "ğŸ“Š Initial container status:"
        docker compose -f docker-compose.test.yml ps
        
        # Wait for PostgreSQL
        echo "â³ Waiting for PostgreSQL..."
        timeout 120 bash -c 'until docker compose -f docker-compose.test.yml exec -T postgres pg_isready -U test_fantasyf1_user -d test_fantasyf1_db; do sleep 2; done'
        echo "âœ… PostgreSQL is ready!"
        
        # Wait for Redis
        echo "â³ Waiting for Redis..."
        timeout 180 bash -c 'until docker compose -f docker-compose.test.yml exec -T redis redis-cli -a test_redis_password_ci_cd_2024 ping 2>/dev/null; do sleep 5; done'
        echo "âœ… Redis is ready!"
        
        # Wait for backend
        echo "â³ Waiting for Backend..."
        timeout 120 bash -c 'until curl -f http://localhost:8000/health > /dev/null 2>&1; do sleep 2; done'
        echo "âœ… Backend is ready!"
        
        # Display final container status
        echo "ğŸ“Š Final container status:"
        docker compose -f docker-compose.test.yml ps
    
    - name: Show service logs if healthy
      if: always()
      run: |
        echo "ğŸ“‹ Container logs for debugging:"
        echo "================================"
        echo ""
        
        echo "ğŸ“Š Docker Compose status:"
        docker compose -f docker-compose.test.yml ps
        
        echo ""
        echo "ğŸ—„ï¸  PostgreSQL logs (last 50 lines):"
        docker compose -f docker-compose.test.yml logs --tail=50 postgres || echo "No PostgreSQL logs"
        
        echo ""
        echo "ğŸ“¨ MQTT logs (last 50 lines):"
        docker compose -f docker-compose.test.yml logs --tail=50 mosquitto || echo "No MQTT logs"
        
        echo ""
        echo "ğŸ”´ Redis logs (last 50 lines):"
        docker compose -f docker-compose.test.yml logs --tail=50 redis || echo "No Redis logs"
        
        echo ""
        echo "ğŸ–¥ï¸  Backend logs (last 100 lines):"
        docker compose -f docker-compose.test.yml logs --tail=100 backend || echo "No backend logs"
    
    - name: Run linting (Black)
      run: |
        echo "ğŸ” Running Black formatter check..."
        docker compose -f docker-compose.test.yml exec -T backend black app/ tests/ --check --line-length=100 || {
          echo "âš ï¸ Black check failed or fix needed"
          exit 1
        }
        echo "âœ… Black check passed"
    
    - name: Run linting (Ruff)
      run: |
        echo "ğŸ” Running Ruff linter check..."
        docker compose -f docker-compose.test.yml exec -T backend ruff check app/ tests/ --exit-zero || {
          echo "âš ï¸ Ruff check found issues"
        }
        echo "âœ… Ruff check completed"
    
    - name: Run type checking (MyPy)
      run: |
        echo "ğŸ” Running MyPy type checking..."
        docker compose -f docker-compose.test.yml exec -T backend mypy app/ || {
          echo "âš ï¸ MyPy check failed or found issues"
          exit 1
        }
        echo "âœ… MyPy check passed"
    
    - name: Run backend tests
      run: |
        echo "ğŸ§ª Running backend tests..."
        docker compose -f docker-compose.test.yml exec -T backend pytest tests/ -v --cov=app --cov-report=xml --tb=short || {
          echo "âŒ Tests failed"
          exit 1
        }
        echo "âœ… All tests passed"
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: FantasyF1_BE/coverage.xml
        fail_ci_if_error: false
    
    - name: Cleanup test containers
      if: always()
      run: |
        echo "ğŸ§¹ Cleaning up test containers..."
        docker compose -f docker-compose.test.yml down -v || true
        echo "âœ… Cleanup complete"

  # Frontend Tests and Build
  test-frontend:
    runs-on: ubuntu-latest
    needs: detect-changes
    if: |
      (needs.detect-changes.outputs.frontend_changed == 'true' || 
       needs.detect-changes.outputs.frontend_config_changed == 'true' ||
       needs.detect-changes.outputs.workflow_changed == 'true')
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
    
    - name: Install frontend dependencies
      run: |
        echo "ğŸ“¦ Installing frontend dependencies..."
        cd frontend
        npm ci
        echo "âœ… Dependencies installed"
    
    - name: Run ESLint
      run: |
        echo "ğŸ” Running ESLint..."
        cd frontend
        npm run lint || {
          echo "âŒ ESLint failed"
          exit 1
        }
        echo "âœ… ESLint passed"
    
    - name: TypeScript type check
      run: |
        echo "ğŸ” Running TypeScript type check..."
        cd frontend
        npx tsc --noEmit || {
          echo "âŒ TypeScript check failed"
          exit 1
        }
        echo "âœ… TypeScript check passed"
    
    - name: Build frontend
      run: |
        echo "ğŸ”¨ Building frontend..."
        cd frontend
        npm run build || {
          echo "âŒ Frontend build failed"
          exit 1
        }
        echo "âœ… Frontend build completed"
    
    - name: Upload frontend build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist
        path: frontend/dist/
        retention-days: 7

  # Backend Build
  build-backend:
    needs: [detect-changes, test-backend]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && 
      !startsWith(github.ref, 'refs/heads/dev/') &&
      (needs.detect-changes.outputs.backend_changed == 'true' || 
       needs.detect-changes.outputs.dockerfile_changed == 'true' ||
       needs.detect-changes.outputs.compose_changed == 'true')
    
    permissions:
      contents: read
      packages: write
    
    outputs:
      digest: ${{ steps.build.outputs.digest }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Generate version
      id: version
      run: |
        # Determine build type based on branch
        if [[ "${{ github.ref_name }}" == "main" ]]; then
          BUILD_TYPE="prod"
          IMAGE_TAG="latest"
        elif [[ "${{ github.ref_name }}" == test/* ]]; then
          BUILD_TYPE="test"
          IMAGE_TAG="test-latest"
        else
          echo "âŒ Invalid branch for image build"
          exit 1
        fi
        
        echo "ğŸ“‹ Build type: $BUILD_TYPE"
        echo "ğŸ“‹ Image tag: $IMAGE_TAG"
        
        # Generate version using CalVer format
        VERSION=$(date +%Y.%m.%d)
        if [ "$BUILD_TYPE" != "prod" ]; then
          VERSION="${VERSION}-${BUILD_TYPE}"
        fi
        
        SHA_SHORT="${GITHUB_SHA::7}"
        VERSION="${VERSION}-${SHA_SHORT}"
        
        echo "ğŸ”– Generated version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
    
    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3
    
    - name: Log in to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_ACCESS_TOKEN }}
  
    - name: Extract metadata
      id: meta
      uses: docker/metadata-action@v5
      with:
        images: docker.io/${{ env.BACKEND_IMAGE_NAME }}
        tags: |
          type=raw,value=${{ steps.version.outputs.version }}
          type=raw,value=${{ steps.version.outputs.image_tag }}
          type=sha,prefix=${{ steps.version.outputs.image_tag }}-
          type=raw,value=latest,enable=${{ github.ref_name == 'main' }}
    
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: FantasyF1_BE
        file: FantasyF1_BE/Dockerfile
        push: true
        tags: ${{ steps.meta.outputs.tags }}
        labels: ${{ steps.meta.outputs.labels }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VCS_REF=${{ github.sha }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VERSION=${{ steps.version.outputs.version }}
    
    
    - name: Print image summary
      run: |
        echo "âœ… Backend image built and pushed successfully!"
        echo "Image: ${{ steps.meta.outputs.tags }}"
        echo "Version: ${{ steps.version.outputs.version }}"
        echo "Digest: ${{ steps.build.outputs.digest }}"
        echo "Full Image Ref: docker.io/famgala/fantasyf1-be@${{ steps.build.outputs.digest }}"

  # Frontend Build
  build-frontend:
    needs: [detect-changes, test-frontend]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && 
      !startsWith(github.ref, 'refs/heads/dev/') &&
      (needs.detect-changes.outputs.frontend_changed == 'true' || 
       needs.detect-changes.outputs.frontend_config_changed == 'true')
    
    permissions:
      contents: read
      packages: write
    
    outputs:
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: 'frontend/package-lock.json'
    
    - name: Generate version
      id: version
      run: |
        # Determine build type based on branch
        if [[ "${{ github.ref_name }}" == "main" ]]; then
          BUILD_TYPE="prod"
          IMAGE_TAG="latest"
        elif [[ "${{ github.ref_name }}" == test/* ]]; then
          BUILD_TYPE="test"
          IMAGE_TAG="test-latest"
        else
          echo "âŒ Invalid branch for image build"
          exit 1
        fi
        
        echo "ğŸ“‹ Build type: $BUILD_TYPE"
        echo "ğŸ“‹ Image tag: $IMAGE_TAG"
        
        # Generate version using CalVer format
        VERSION=$(date +%Y.%m.%d)
        if [ "$BUILD_TYPE" != "prod" ]; then
          VERSION="${VERSION}-${BUILD_TYPE}"
        fi
        
        SHA_SHORT="${GITHUB_SHA::7}"
        VERSION="${VERSION}-${SHA_SHORT}"
        
        echo "ğŸ”– Generated version: $VERSION"
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "image_tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
    
    - name: Install dependencies
      run: |
        echo "ğŸ“¦ Installing frontend dependencies..."
        cd frontend
        npm ci
        echo "âœ… Dependencies installed"
    
    - name: Build frontend
      run: |
        echo "ğŸ”¨ Building frontend..."
        cd frontend
        npm run build || {
          echo "âŒ Frontend build failed"
          exit 1
        }
        echo "âœ… Frontend build completed"
    
    - name: Upload frontend build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: frontend-dist-${{ steps.version.outputs.version }}
        path: frontend/dist/
        retention-days: 30
    
    - name: Build and push Docker image
      id: build
      uses: docker/build-push-action@v5
      with:
        context: frontend
        file: frontend/Dockerfile
        push: true
        tags: |
          docker.io/famgala/fantasyf1-fe:${{ steps.version.outputs.version }}
          docker.io/famgala/fantasyf1-fe:${{ steps.version.outputs.image_tag }}
          docker.io/famgala/fantasyf1-fe:latest,enable=${{ github.ref_name == 'main' }}
        labels: |
          org.opencontainers.image.title=FantasyF1 Frontend
          org.opencontainers.image.version=${{ steps.version.outputs.version }}
          org.opencontainers.image.created=${{ github.event.head_commit.timestamp }}
          org.opencontainers.image.revision=${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        build-args: |
          VCS_REF=${{ github.sha }}
          BUILD_DATE=${{ github.event.head_commit.timestamp }}
          VERSION=${{ steps.version.outputs.version }}
    
    - name: Print image summary
      run: |
        echo "âœ… Frontend image built and pushed successfully!"
        echo "Version: ${{ steps.version.outputs.version }}"
        echo "Digest: ${{ steps.build.outputs.digest }}"
        echo "Full Image Ref: docker.io/famgala/fantasyf1-fe:${{ steps.version.outputs.version }}"

  # Security Scan for Backend
  security-scan-backend:
    needs: [detect-changes, build-backend]
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' && 
      (needs.detect-changes.outputs.backend_changed == 'true' || 
       needs.detect-changes.outputs.dockerfile_changed == 'true')
    
    permissions:
      contents: read
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Pull Docker image for scanning
      run: |
        echo "ğŸ” Pulling Docker image for security scanning..."
        docker pull docker.io/famgala/fantasyf1-be@${{ needs.build-backend.outputs.digest }}
        echo "âœ… Image pulled successfully"
    
    - name: Run Trivy vulnerability scanner
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: docker.io/famgala/fantasyf1-be@${{ needs.build-backend.outputs.digest }}
        format: 'sarif'
        output: 'trivy-backend-results.sarif'
        severity: 'CRITICAL,HIGH'
    
    - name: Upload Trivy scan results as artifacts
      uses: actions/upload-artifact@v4
      with:
        name: trivy-backend-security-scan
        path: trivy-backend-results.sarif
        retention-days: 30
    
    - name: Display Trivy summary
      run: |
        echo "ğŸ”’ Backend Security Scan Summary"
        echo "================================"
        if [ -f trivy-backend-results.sarif ]; then
          echo "âœ… SARIF file generated successfully"
          echo "ğŸ“¦ Available as artifact: trivy-backend-security-scan"
          echo "ğŸ“… Retention: 30 days"
        else
          echo "âŒ No SARIF file found"
          exit 1
        fi