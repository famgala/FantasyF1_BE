#!/bin/bash

# ============================================
# Pre-commit Hook
# Runs CI checks based on what files changed
# Works on Unix/Linux/Mac and Windows (Git Bash)
# ============================================

echo "============================================"
echo "Running Pre-commit Checks"
echo "============================================"

# Get the list of staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
EXIT_CODE=0

# Check if there are any staged files
if [ -z "$STAGED_FILES" ]; then
    echo "No staged files. Skipping pre-commit checks."
    exit 0
fi

# Detect what changed
BACKEND_CHANGED=false
FRONTEND_CHANGED=false

for FILE in $STAGED_FILES; do
    if [[ "$FILE" == FantasyF1_BE/* ]]; then
        BACKEND_CHANGED=true
    fi
    if [[ "$FILE" == frontend/* ]]; then
        FRONTEND_CHANGED=true
    fi
done

echo ""
echo "üìã Changed files detected:"
if [ "$BACKEND_CHANGED" = true ]; then
    echo "  ‚úÖ Backend files changed"
fi
if [ "$FRONTEND_CHANGED" = true ]; then
    echo "  ‚úÖ Frontend files changed"
fi
echo ""

# Run backend checks if backend changed
if [ "$BACKEND_CHANGED" = true ]; then
    echo "============================================"
    echo "Running Backend Checks"
    echo "============================================"
    
    # Change to backend directory
    cd FantasyF1_BE || exit 1
    
    # 1. Black formatter check
    echo ""
    echo "[1/4] Running Black formatter check..."
    if black --check app/ tests/ > /dev/null 2>&1; then
        echo "‚úÖ Black check passed"
    else
        echo "‚ùå Black check failed - run 'black app/ tests/' to fix"
        EXIT_CODE=1
    fi
    
    # 2. Ruff linter
    echo ""
    echo "[2/4] Running Ruff linter..."
    if ruff check app/ tests/ > /dev/null 2>&1; then
        echo "‚úÖ Ruff check passed"
    else
        echo "‚ùå Ruff check failed - run 'ruff check app/ tests/ --fix' to fix"
        EXIT_CODE=1
    fi
    
    # 3. mypy type checker
    echo ""
    echo "[3/4] Running MyPy type checker..."
    if mypy app/ > /dev/null 2>&1; then
        echo "‚úÖ MyPy check passed"
    else
        echo "‚ùå MyPy check failed - run 'mypy app/' to see issues"
        EXIT_CODE=1
    fi
    
    # 4. pytest with coverage (only if tests directory changed or app directory changed)
    echo ""
    echo "[4/4] Checking if tests need to be run..."
    TESTS_CHANGED=false
    for FILE in $STAGED_FILES; do
        if [[ "$FILE" == FantasyF1_BE/tests/* ]] || [[ "$FILE" == FantasyF1_BE/app/services/* ]] || [[ "$FILE" == FantasyF1_BE/app/api/* ]]; then
            TESTS_CHANGED=true
            break
        fi
    done
    
    if [ "$TESTS_CHANGED" = true ]; then
        echo "üß™ Running pytest with coverage..."
        if pytest tests/ --cov=app --cov-report=html > /dev/null 2>&1; then
            echo "‚úÖ pytest passed"
        else
            echo "‚ùå pytest failed - run 'pytest tests/ --cov=app' to see issues"
            EXIT_CODE=1
        fi
    else
        echo "‚è≠Ô∏è  Skipping pytest (no test files or service files changed)"
    fi
    
    # Return to root directory
    cd ..
fi

# Run frontend checks if frontend changed
if [ "$FRONTEND_CHANGED" = true ]; then
    echo ""
    echo "============================================"
    echo "Running Frontend Checks"
    echo "============================================"
    
    # Change to frontend directory
    cd frontend || exit 1
    
    # 1. ESLint
    echo ""
    echo "[1/3] Running ESLint..."
    if npm run lint > /dev/null 2>&1; then
        echo "‚úÖ ESLint passed"
    else
        echo "‚ùå ESLint failed - run 'npm run lint' to see issues"
        EXIT_CODE=1
    fi
    
    # 2. TypeScript type check
    echo ""
    echo "[2/3] Running TypeScript type check..."
    if npx tsc --noEmit > /dev/null 2>&1; then
        echo "‚úÖ TypeScript check passed"
    else
        echo "‚ùå TypeScript check failed - run 'npx tsc --noEmit' to see issues"
        EXIT_CODE=1
    fi
    
    # 3. Build check (only if source files changed)
    echo ""
    echo "[3/3] Checking if build needs to be run..."
    SOURCE_CHANGED=false
    for FILE in $STAGED_FILES; do
        if [[ "$FILE" == frontend/src/* ]] || [[ "$FILE" == frontend/tsconfig*.json ]] || [[ "$FILE" == frontend/vite.config.ts ]] || [[ "$FILE" == frontend/package.json ]]; then
            SOURCE_CHANGED=true
            break
        fi
    done
    
    if [ "$SOURCE_CHANGED" = true ]; then
        echo "üî® Testing frontend build..."
        if npm run build > /dev/null 2>&1; then
            echo "‚úÖ Frontend build succeeded"
            # Clean up build artifacts
            rm -rf dist
        else
            echo "‚ùå Frontend build failed - run 'npm run build' to see issues"
            EXIT_CODE=1
        fi
    else
        echo "‚è≠Ô∏è  Skipping build (no source files changed)"
    fi
    
    # Return to root directory
    cd ..
fi

# Final summary
echo ""
echo "============================================"
if [ $EXIT_CODE -eq 0 ]; then
    echo "‚úÖ All pre-commit checks passed!"
    echo "You're ready to commit your changes."
else
    echo "‚ùå Some pre-commit checks failed."
    echo "Please fix the issues above before committing."
    echo ""
    echo "üí° Tips:"
    echo "  - Run 'bash FantasyF1_BE/scripts/run_ci_checks.sh' for backend checks"
    echo "  - Run 'cd frontend && npm run lint && npm run build' for frontend checks"
fi
echo "============================================"

exit $EXIT_CODE