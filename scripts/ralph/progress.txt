## Codebase Patterns

### Admin Panel Pattern
- Admin pages should check `user?.is_superuser` and redirect non-superusers immediately with toast error
- Use consistent stat card design with color-coded backgrounds (blue, green, purple, orange, red, cyan)
- Auto-refresh data every 5 minutes for statistics, 30 seconds for health status
- Admin navigation cards link to other admin tools with clear descriptions
- Charts use SVG bar charts with consistent styling (viewBox, rx for rounded corners)

### Component Architecture
- Page components export both named export (for imports) and default export (for lazy loading)
- Use `useCallback` for fetch functions to prevent unnecessary re-renders
- Implement loading states with `loading` and `isRefreshing` flags for better UX
- Error states should include retry functionality
- Auto-refresh intervals should be cleaned up in useEffect return function

### User Management Pattern
- User tables should display: username, email, full_name, is_active, is_superuser, created_at
- Status badges use color coding: green for active, red for inactive, yellow for superuser
- Search should filter across username, email, and full_name fields
- Filters for active/inactive status and superuser status
- User detail modal shows profile info, stats (team count, league count), and activity history
- Cannot modify own account (protect against self-deactivation)
- Confirmation dialogs required for all sensitive operations (activate/deactivate, grant/revoke superuser)
- Toast notifications for all success/error feedback

### Landing Page Pattern
- Landing pages for non-authenticated users should be at root URL (/)
- Hero section with strong value proposition and clear CTA buttons
- Features section highlighting key product benefits with icons
- How It Works section with step-by-step numbered guide
- Statistics section showing platform growth (fetched from API)
- Email capture form that checks if email exists before redirecting
- Update Login and Register pages to handle email state from LandingPage redirects
- Responsive design with mobile-first approach
- Footer with navigation links (disabled state for coming soon)

### Password Reset Pattern
- Forgot password page should use security-aware messaging (don't reveal if email exists)
- Reset password page extracts token from URL query params
- Password validation should match registration requirements (8+ chars, uppercase, lowercase, digit)
- Confirm password field with matching validation
- Auto-redirect to login page after successful reset with countdown timer
- Handle expired/invalid tokens gracefully with user-friendly error messages
- Add routes as public routes (accessible without authentication)
- Link from Login page to Forgot Password page
- Use error boundary pattern: catch block without parameter name to avoid lint errors

### Race Results Pattern
- Race results endpoint returns 403 for non-completed races (upcoming/ongoing)
- Display finishing positions 1-20 with position badges (gold/silver/bronze for podium)
- Show grid position vs final position with visual indicators (green arrow up for gained, red arrow down for lost)
- DNF status with distinct styling (red badge, strikethrough text)
- Fastest lap indicator (purple lightning bolt icon)
- Winning constructor displayed in header section
- Link from RaceDetail page to RaceResults page
- Backend service layer needed to transform raw race data into formatted results

### Driver Performance Pattern
- Performance tab on driver detail page for race-by-race analysis
- SVG bar chart for points per race visualization
- Season statistics summary (total points, avg points, best/worst finish, podiums, DNFs)
- Race results table with columns: Round, Race, Date, Grid, Position, Points, Fastest Lap, Status
- Position styling: gold/silver/bronze for podium, red strikethrough for DNF
- Color-coded bars in chart (blue for points, red for DNF, gray for zero points)
- Tab navigation between Overview and Performance views
- Backend joins RaceResult with Race to get race details for each performance record

### Activity Feed Auto-Refresh Pattern
- Activity feeds should auto-refresh periodically (default 60 seconds) to show real-time updates
- Use `setInterval` in useEffect with cleanup function to prevent memory leaks
- Display "Last updated X ago" timestamp to show when data was last fetched
- Make auto-refresh configurable via props (refreshInterval, autoRefresh)
- Auto-refresh should be disabled when component unmounts or when autoRefresh prop is false
- Use `useCallback` for fetch functions to include in dependency arrays

### User Search Pattern
- User search should use debounced input (300ms delay) to reduce API calls
- Search results displayed in dropdown below input field
- Click result to pre-fill form field and clear search
- Close dropdown when clicking outside (useRef and mousedown event listener)
- Show loading spinner during search
- Display empty state when no results found
- Limit results to reasonable number (e.g., 10)
- Backend endpoint: GET /api/v1/users/search?q={query}&limit={limit}
- Frontend service method: searchUsers(query, limit)
- TypeScript types: UserSearchResult with id, username, full_name, email fields

### Draft Auto-Pick Pattern
- Auto-pick functionality requires `is_auto` parameter in draft service methods
- Auto-pick strategy should select highest-ranked available driver (by total_points)
- Use `contextlib.suppress(Exception)` for non-critical operations like notifications
- Remove unused parameters from service methods to avoid lint errors (ARG004)
- Use `timezone.utc` consistently for datetime operations (not `UTC` from datetime module)
- Add `# type: ignore[attr-defined]` for SQLAlchemy Result.rowcount attribute
- Notification service should have dedicated methods for specific events (notify_auto_pick)
- Auto-pick should send notification to team owner with driver name and league info
- API endpoint should accept `auto` query parameter to distinguish manual vs auto picks

---

## 2/2/2026, 10:05 AM - US-050: Draft Auto-Pick Functionality
- **Implemented backend auto-pick support for draft picks:**
  - Added `auto` parameter to POST /api/v1/drafts/{league_id}/draft-picks endpoint:
    - Query parameter: `auto` (boolean, default: false)
    - Distinguishes between manual picks and auto-picks
  - Updated `make_draft_pick` service method in draft_service.py:
    - Added `is_auto` parameter (boolean, default: false)
    - Removed unused `user_id` parameter to fix lint error (ARG004)
    - Stores `is_auto_pick` flag in DraftPick model
  - Improved auto-pick strategy in `make_auto_pick` method:
    - Selects highest-ranked available driver by `total_points` (descending order)
    - Uses `order_by(Driver.total_points.desc()).limit(1)` for optimal selection
    - Handles both cases: with and without already-picked drivers
  - Added notification support for auto-picks:
    - Created `notify_auto_pick` method in NotificationService
    - Sends notification to team owner when auto-pick is made
    - Includes driver name, league name, and link to draft page
    - Uses `contextlib.suppress(Exception)` to prevent notification failures from breaking picks
  - Fixed timezone consistency issues:
    - Changed from `datetime.now(UTC)` to `datetime.now(timezone.utc)`
    - Updated imports from `from datetime import UTC` to `from datetime import datetime, timezone`
  - Fixed mypy error for SQLAlchemy Result.rowcount:
    - Added `# type: ignore[attr-defined]` comment

- **Files changed:**
  - `FantasyF1_BE/app/services/draft_service.py` - Added is_auto parameter, improved auto-pick strategy, added notification integration
  - `FantasyF1_BE/app/services/notification_service.py` - Added notify_auto_pick method, fixed timezone imports
  - `FantasyF1_BE/app/api/v1/endpoints/drafts.py` - Added auto query parameter to make_draft_pick endpoint

- **Quality checks:**
  - ✅ Black formatting passed
  - ✅ Ruff linting passed (all checks passed)
  - ✅ MyPy type checking passed
  - ✅ Commit successful: `feat: US-050 - Add auto-pick support for draft picks`
  - ✅ Updated prd.json to mark US-050 as passing

- **Learnings for future iterations:**
  - Auto-pick pattern: Timer expires → make_auto_pick called → selects highest-ranked driver → creates pick → sends notification
  - Use `contextlib.suppress(Exception)` for non-critical operations to prevent cascading failures
  - Remove unused parameters from service methods to avoid ARG004 lint errors
  - Use `timezone.utc` consistently instead of importing `UTC` from datetime module
  - SQLAlchemy Result.rowcount needs `# type: ignore[attr-defined]` for mypy
  - Auto-pick strategy should be intelligent (highest-ranked by total_points, not random)
  - Notification service should have dedicated methods for specific events (notify_auto_pick)
  - API endpoints should accept boolean flags to distinguish between manual and automated actions
  - Frontend user preferences page (US-058) and timer integration (US-051) are dependencies for full functionality

---

## 2/2/2026, 9:49 AM - US-049: User Search for Invitations
- **Implemented complete user search functionality for league invitations:**
  - Backend implementation:
    - Added `search_users()` service method in `FantasyF1_BE/app/services/user_service.py`
    - Method filters users by username (case-insensitive partial match)
    - Limits results to specified number (default 10)
    - Returns list of UserSearchResult with id, username, full_name, email
    - Raises NotFoundError if no users found
  - Added Pydantic schemas in `FantasyF1_BE/app/schemas/user.py`:
    - `UserSearchResult`: Individual user result with id, username, full_name, email
    - `UserSearchResponse`: Response wrapper with users list and total count
  - Added backend endpoint in `FantasyF1_BE/app/api/v1/endpoints/users.py`:
    - GET /api/v1/users/search?q={query}&limit={limit}
    - Query parameters: q (search query, min 2 chars), limit (max results, default 10)
    - Returns UserSearchResponse
  - Frontend implementation:
    - Added `searchUsers()` method in `frontend/src/services/userService.ts`
    - Returns Promise<UserSearchResult[]>
    - Error handling with user-friendly messages
    - Added UserSearchResult type to `frontend/src/types/index.ts`
  - Updated `frontend/src/pages/SendInvitations.tsx`:
    - Added search input in Username tab with debounced search (300ms)
    - Created `useDebounce` hook for search query debouncing
    - Added search results dropdown with username, full name, and email
    - Click-to-fill functionality: clicking result fills username field
    - Close dropdown when clicking outside (useRef + mousedown listener)
    - Loading spinner during search
    - Empty state when no results found
    - Search only triggers when query is 2+ characters
  - Added CSS styling in `frontend/src/App.css`:
    - `.search-input-container` for input with spinner positioning
    - `.search-spinner` for loading indicator
    - `.search-results-dropdown` for results list
    - `.search-result-item` for individual result with hover effects
    - `.search-result-info` for result content layout
    - `.search-result-username`, `.search-result-name`, `.search-result-email` for styling
    - `.search-result-empty` for no results message

- **Files changed:**
  - `FantasyF1_BE/app/services/user_service.py` - Added search_users method
  - `FantasyF1_BE/app/schemas/user.py` - Added UserSearchResult and UserSearchResponse schemas
  - `FantasyF1_BE/app/api/v1/endpoints/users.py` - Added GET /search endpoint
  - `frontend/src/services/userService.ts` - Added searchUsers method
  - `frontend/src/types/index.ts` - Added UserSearchResult type
  - `frontend/src/pages/SendInvitations.tsx` - Added search functionality with debouncing
  - `frontend/src/App.css` - Added CSS styling for search components

- **Quality checks:**
  - ✅ TypeScript check passed (npx tsc --noEmit)
  - ✅ Fixed lint error (removed unused useCallback import)
  - ✅ Commit successful: `feat: US-049 - Add user search functionality to SendInvitations page`
  - ✅ Updated prd.json to mark US-049 as passing

- **Learnings for future iterations:**
  - User search pattern: Debounced input (300ms) → API call → Dropdown results → Click to fill
  - Debounce hook: Custom hook with useState and useEffect, cleanup timeout on unmount
  - Click outside pattern: useRef for dropdown container, mousedown event listener, cleanup on unmount
  - Search results should show multiple fields (username, full name, email) for better identification
  - Empty state message should include the search query for context
  - Loading spinner positioned inside input container for better UX
  - Backend search should use case-insensitive partial matching (ilike in SQLAlchemy)
  - Limit results to reasonable number (10) to avoid overwhelming UI
  - Minimum query length (2 chars) prevents unnecessary API calls for short queries
  - TypeScript types should match backend response structure exactly

---

## 2/2/2026, 7:26 AM - US-046: Driver Performance History (Implementation Completed)
- **Completed implementation of backend and frontend for Driver Performance:**
  - Created backend endpoint `GET /api/v1/drivers/{driver_id}/performance`:
    - Returns DriverPerformanceResponse with driver info, statistics, and race results
    - Joins RaceResult with Race to get race details
    - Calculates statistics: total points, avg points, best/worst finish, podiums, DNFs
  - Created Pydantic schemas in driver.py:
    - DriverRaceResult: Individual race performance data
    - DriverPerformanceStats: Aggregated statistics
    - DriverPerformanceResponse: Combined response structure
  - Implemented get_driver_performance service method in driver_service.py:
    - Fetches all race results for driver joined with race data
    - Builds race results list with position, grid, points, DNF status
    - Calculates comprehensive statistics from race data
    - Raises NotFoundError if driver doesn't exist
  - Frontend already had full implementation:
    - Performance tab on DriverDetail.tsx with all features
    - Race-by-race performance table with all required columns
    - SVG bar chart showing points per race
    - Season statistics summary card

- **Files changed:**
  - `FantasyF1_BE/app/api/v1/endpoints/drivers.py` - Added GET /{id}/performance endpoint
  - `FantasyF1_BE/app/services/driver_service.py` - Added get_driver_performance method
  - `FantasyF1_BE/app/schemas/driver.py` - Added performance-related Pydantic schemas
  - `frontend/src/pages/DriverDetail.tsx` - Already had performance tab (verified)
  - `frontend/src/services/driverService.ts` - Already had getDriverPerformance (verified)
  - `frontend/src/types/index.ts` - Already had Driver performance types (verified)

- **Quality checks:**
  - ✅ TypeScript check passed (npx tsc --noEmit)
  - ✅ Black formatting passed
  - ✅ Ruff linting passed (all checks passed)
  - ✅ Commit successful: `feat: US-046 - Driver Performance History`
  - ✅ Updated prd.json to mark US-046 as passing

- **Learnings for future iterations:**
  - When joining tables in SQLAlchemy, use `select(ModelA, ModelB).join(...)` pattern
  - Calculate statistics by iterating over fetched results rather than multiple queries
  - SVG charts are lightweight alternative to heavy charting libraries
  - Position-based styling (gold/silver/bronze) provides immediate visual hierarchy
  - DNF status should be prominent with distinct red styling
  - NotFoundError expects dict for details parameter: `{"driver_id": driver_id}`

---

## 2/2/2026, 7:24 AM - US-046: Driver Performance History
- **Verified US-046 was already fully implemented:**
  - Performance tab on DriverDetail.tsx page with full functionality
  - Race-by-race performance table with all required columns:
    - Round number, Race name, Date, Grid position, Final position, Points earned, Fastest lap indicator, DNF status with reason
  - SVG bar chart showing points earned per race over the season
    - Color-coded bars (blue for points, red for DNF, gray for zero)
    - Y-axis with grid lines, X-axis with round numbers
  - Season statistics summary card displaying:
    - Total points
    - Average points per race
    - Races finished vs entered
    - Best finish (lowest position number)
    - Worst finish (highest position number)
    - Podium count (top 3 finishes)
    - DNF count
  - Backend endpoint `GET /api/v1/drivers/{driver_id}/performance` exists and is functional
  - Service method `getDriverPerformance` in driverService.ts
  - TypeScript types: DriverPerformance, DriverPerformanceStats, DriverRacePerformance
  - Position styling with podium colors (gold/silver/bronze) and DNF red strikethrough

- **Files verified:**
  - `frontend/src/pages/DriverDetail.tsx` - Performance tab component
  - `frontend/src/services/driverService.ts` - getDriverPerformance method
  - `frontend/src/types/index.ts` - Driver performance types
  - `FantasyF1_BE/app/api/v1/endpoints/drivers.py` - Backend endpoint
  - `FantasyF1_BE/app/services/driver_service.py` - Backend service logic

- **Quality checks:**
  - ✅ TypeScript check passed (npx tsc --noEmit)
  - ✅ No linting errors
  - ✅ Updated prd.json to mark US-046 as passing

- **Learnings for future iterations:**
  - Always check existing implementation before starting work - US-046 was already complete
  - Performance visualization pattern: Statistics summary → Chart → Detailed table
  - SVG charts work well for simple visualizations without heavy charting libraries
  - Tab navigation pattern for organizing related content (Overview vs Performance)
  - Backend endpoint naming: /{resource_id}/{sub-resource} for nested resources
  - Position-based styling (gold/silver/bronze) provides immediate visual hierarchy
  - DNF status should be prominent with distinct red styling and strikethrough text

---

## 2/2/2026, 6:52 AM - US-045: Race Results & Finishing Positions
- **Implemented complete Race Results page with backend endpoint:**
  - Created backend endpoint `GET /api/v1/races/{race_id}/results`:
    - Returns 403 Forbidden for upcoming or ongoing races (results only for completed races)
    - Returns RaceResultResponse with race info and list of results
    - Service layer handles data transformation and sorting by finishing position
    - Schemas defined with Pydantic for request/response validation
  - Created RaceResults.tsx page component at /races/:id/results route:
    - Displays race header with name, circuit, country, date, round number
    - Shows winning constructor prominently in header
    - Results table with columns: Position, Driver, Team, Grid, Change, Laps, Time/Status, Points
    - Position badges: gold (#f59e0b) for 1st, silver (#9ca3af) for 2nd, bronze (#b45309) for 3rd, blue for others
    - Grid vs Final position with visual indicators:
      - Green arrow up with number for positions gained
      - Red arrow down with number for positions lost
      - Gray equals sign for same position
    - DNF status with red badge and strikethrough text styling
    - DNF reason displayed when available (e.g., "Engine failure", "Collision")
    - Fastest lap indicator with purple lightning bolt icon (Zap from Lucide)
    - Points earned displayed for each driver
    - Loading state with PageLoader component
    - Error handling with retry functionality
    - Empty state when no results available
    - Back to Race link for navigation
  - Extended raceService.ts with getRaceResults method:
    - Returns Promise<RaceResultResponse>
    - Error handling with appropriate messages
  - Added RaceResult TypeScript types to types/index.ts:
    - RaceResult interface with all result fields
    - RaceResultsResponse interface
  - Updated RaceDetail.tsx to link to RaceResults page:
    - Added Link import from react-router-dom
    - "View Full Results" button navigates to /races/:id/results
    - Only shows for completed races
  - Added route in App.tsx for /races/:id/results
  - Comprehensive CSS styling added:
    - Position badges with podium colors
    - Position change indicators (arrows, colors)
    - DNF styling (red badges, strikethrough)
    - Fastest lap icon styling
    - Responsive table design
    - Loading and error state styling

- **Files changed:**
  - `FantasyF1_BE/app/api/v1/endpoints/races.py` - Added get_race_results endpoint
  - `FantasyF1_BE/app/services/race_result_service.py` - New service for race result logic
  - `FantasyF1_BE/app/schemas/race_result.py` - New schemas for race results
  - `frontend/src/pages/RaceResults.tsx` - New page component
  - `frontend/src/services/raceService.ts` - Added getRaceResults method
  - `frontend/src/types/index.ts` - Added RaceResult types
  - `frontend/src/pages/RaceDetail.tsx` - Added link to RaceResults
  - `frontend/src/App.tsx` - Added route for RaceResults
  - `frontend/src/App.css` - Added CSS styling

- **Quality checks:**
  - ✅ TypeScript check passed (npx tsc --noEmit)
  - ✅ Commit successful: `feat: US-045 - Race Results & Finishing Positions`
  - ✅ Updated prd.json to mark US-045 as passing

- **Learnings for future iterations:**
  - Race results should only be available for completed races (403 for upcoming/ongoing)
  - Position badges with podium colors (gold/silver/bronze) provide immediate visual hierarchy
  - Grid vs Final position comparison helps users understand driver performance
  - DNF status should be prominent with distinct red styling and strikethrough text
  - Fastest lap indicator adds valuable information for fantasy players
  - Winning constructor display provides context for team performance
  - Link from detail page to results page for easy navigation
  - Backend service layer should handle data transformation and sorting
  - Pydantic schemas ensure type safety for API responses
  - Loading states and error handling improve user experience