## Codebase Patterns

### Admin Panel Pattern
- Admin pages should check `user?.is_superuser` and redirect non-superusers immediately with toast error
- Use consistent stat card design with color-coded backgrounds (blue, green, purple, orange, red, cyan)
- Auto-refresh data every 5 minutes for statistics, 30 seconds for health status
- Admin navigation cards link to other admin tools with clear descriptions
- Charts use SVG bar charts with consistent styling (viewBox, rx for rounded corners)

### Component Architecture
- Page components export both named export (for imports) and default export (for lazy loading)
- Use `useCallback` for fetch functions to prevent unnecessary re-renders
- Implement loading states with `loading` and `isRefreshing` flags for better UX
- Error states should include retry functionality
- Auto-refresh intervals should be cleaned up in useEffect return function

### User Management Pattern
- User tables should display: username, email, full_name, is_active, is_superuser, created_at
- Status badges use color coding: green for active, red for inactive, yellow for superuser
- Search should filter across username, email, and full_name fields
- Filters for active/inactive status and superuser status
- User detail modal shows profile info, stats (team count, league count), and activity history
- Cannot modify own account (protect against self-deactivation)
- Confirmation dialogs required for all sensitive operations (activate/deactivate, grant/revoke superuser)
- Toast notifications for all success/error feedback

### Landing Page Pattern
- Landing pages for non-authenticated users should be at root URL (/)
- Hero section with strong value proposition and clear CTA buttons
- Features section highlighting key product benefits with icons
- How It Works section with step-by-step numbered guide
- Statistics section showing platform growth (fetched from API)
- Email capture form that checks if email exists before redirecting
- Update Login and Register pages to handle email state from LandingPage redirects
- Responsive design with mobile-first approach
- Footer with navigation links (disabled state for coming soon)

### Password Reset Pattern
- Forgot password page should use security-aware messaging (don't reveal if email exists)
- Reset password page extracts token from URL query params
- Password validation should match registration requirements (8+ chars, uppercase, lowercase, digit)
- Confirm password field with matching validation
- Auto-redirect to login page after successful reset with countdown timer
- Handle expired/invalid tokens gracefully with user-friendly error messages
- Add routes as public routes (accessible without authentication)
- Link from Login page to Forgot Password page
- Use error boundary pattern: catch block without parameter name to avoid lint errors

### Race Results Pattern
- Race results endpoint returns 403 for non-completed races (upcoming/ongoing)
- Display finishing positions 1-20 with position badges (gold/silver/bronze for podium)
- Show grid position vs final position with visual indicators (green arrow up for gained, red arrow down for lost)
- DNF status with distinct styling (red badge, strikethrough text)
- Fastest lap indicator (purple lightning bolt icon)
- Winning constructor displayed in header section
- Link from RaceDetail page to RaceResults page
- Backend service layer needed to transform raw race data into formatted results

### Driver Performance Pattern
- Performance tab on driver detail page for race-by-race analysis
- SVG bar chart for points per race visualization
- Season statistics summary (total points, avg points, best/worst finish, podiums, DNFs)
- Race results table with columns: Round, Race, Date, Grid, Position, Points, Fastest Lap, Status
- Position styling: gold/silver/bronze for podium, red strikethrough for DNF
- Color-coded bars in chart (blue for points, red for DNF, gray for zero points)
- Tab navigation between Overview and Performance views
- Backend joins RaceResult with Race to get race details for each performance record

### Activity Feed Auto-Refresh Pattern
- Activity feeds should auto-refresh periodically (default 60 seconds) to show real-time updates
- Use `setInterval` in useEffect with cleanup function to prevent memory leaks
- Display "Last updated X ago" timestamp to show when data was last fetched
- Make auto-refresh configurable via props (refreshInterval, autoRefresh)
- Auto-refresh should be disabled when component unmounts or when autoRefresh prop is false
- Use `useCallback` for fetch functions to include in dependency arrays

### User Search Pattern
- User search should use debounced input (300ms delay) to reduce API calls
- Search results displayed in dropdown below input field
- Click result to pre-fill form field and clear search
- Close dropdown when clicking outside (useRef and mousedown event listener)
- Show loading spinner during search
- Display empty state when no results found
- Limit results to reasonable number (e.g., 10)
- Backend endpoint: GET /api/v1/users/search?q={query}&limit={limit}
- Frontend service method: searchUsers(query, limit)
- TypeScript types: UserSearchResult with id, username, full_name, email fields

### Draft Auto-Pick Pattern
- Auto-pick functionality requires `is_auto` parameter in draft service methods
- Auto-pick strategy should select highest-ranked available driver (by total_points)
- Use `contextlib.suppress(Exception)` for non-critical operations like notifications
- Remove unused parameters from service methods to avoid lint errors (ARG004)
- Use `timezone.utc` consistently for datetime operations (not `UTC` from datetime module)
- Add `# type: ignore[attr-defined]` for SQLAlchemy Result.rowcount attribute
- Notification service should have dedicated methods for specific events (notify_auto_pick)
- Auto-pick should send notification to team owner with driver name and league info
- API endpoint should accept `auto` query parameter to distinguish manual vs auto picks

### Draft Timer Pattern
- Timer configuration stored in League model: pick_timer_seconds (default 60), is_draft_paused (default false)
- Pick start time stored in DraftPick model: pick_started_at (nullable)
- Timer calculation: remaining_seconds = pick_timer_seconds - (now - pick_started_at).total_seconds()
- Timer info returned by draft_status endpoint: time_remaining, is_paused, pick_started_at
- Frontend CountdownTimer component: displays minutes/seconds, auto-refreshes every second
- Visual warning when < 10 seconds: red color, pulse animation
- Timer pauses when is_draft_paused is true, resumes when false
- Timer resets for each new pick (pick_started_at updated when pick is made)
- Use `timezone.utc` consistently for datetime operations (not `UTC` from datetime module)
- Test fixtures need to use `datetime.now(timezone.utc)` instead of `datetime.now(UTC)`

### JSX Fragment Pattern
- JSX fragments (`<>...</>`) must be properly closed with `</>`
- When using fragments, ensure all opening tags have corresponding closing tags
- Common error: missing `</>` at the end of return statement
- Always verify fragment structure when adding/removing JSX elements
- TypeScript compiler will catch unclosed fragments with "has no corresponding closing tag" error

---

## 2/2/2026, 7:35 PM - US-051: Draft Pick Timer & Countdown (JSX Fragment Fixes)
- **Fixed JSX fragment syntax errors in multiple page components:**
  - Fixed EditLeague.tsx: Added missing `</>` closing tag for JSX fragment
  - Fixed LeagueLeaderboard.tsx: Added missing `</>` closing tag for JSX fragment
  - Fixed LeagueRoles.tsx: Added missing `</>` closing tag for JSX fragment
  - Fixed Profile.tsx: Added missing `</div>` closing tag for profile-card div
  - Fixed Register.tsx: Added missing `</>` closing tag for JSX fragment
  - Fixed ViewDraftOrder.tsx: Added missing `</>` closing tag for JSX fragment
  - All files now have properly closed JSX fragments and divs

- **Files changed:**
  - `frontend/src/pages/EditLeague.tsx` - Fixed JSX fragment closing tag
  - `frontend/src/pages/LeagueLeaderboard.tsx` - Fixed JSX fragment closing tag
  - `frontend/src/pages/LeagueRoles.tsx` - Fixed JSX fragment closing tag
  - `frontend/src/pages/Profile.tsx` - Fixed missing div closing tag
  - `frontend/src/pages/Register.tsx` - Fixed JSX fragment closing tag
  - `frontend/src/pages/ViewDraftOrder.tsx` - Fixed JSX fragment closing tag

- **Quality checks:**
  - ✅ Commit successful: `feat: US-051 - Draft Pick Timer & Countdown`
  - ✅ US-051 already marked as passing in prd.json

- **Learnings for future iterations:**
  - JSX fragments (`<>...</>`) must be properly closed with `</>`
  - When using fragments, ensure all opening tags have corresponding closing tags
  - Common error: missing `</>` at the end of return statement
  - Always verify fragment structure when adding/removing JSX elements
  - TypeScript compiler will catch unclosed fragments with "has no corresponding closing tag" error
  - Note: There are pre-existing TypeScript errors in the frontend (unrelated to JSX fragments) that are not part of this user story

---

## 2/2/2026, 7:25 PM - US-051: Draft Pick Timer & Countdown
- **Implemented complete draft timer functionality with backend and frontend:**
  - Backend implementation:
    - Added timer fields to League model in `FantasyF1_BE/app/models/league.py`:
      - `pick_timer_seconds`: Integer, default 60, nullable
      - `is_draft_paused`: Boolean, default false
    - Added `pick_started_at` field to DraftPick model in `FantasyF1_BE/app/models/draft.py`:
      - DateTime, nullable, tracks when current pick started
    - Created database migration `002_add_draft_timer_fields.py`:
      - Adds pick_timer_seconds and is_draft_paused to leagues table
      - Adds pick_started_at to draft_picks table
    - Updated DraftService in `FantasyF1_BE/app/services/draft_service.py`:
      - Added `get_timer_info()` method to calculate remaining time
      - Returns TimerInfo with time_remaining, is_paused, pick_started_at
      - Calculation: remaining = pick_timer_seconds - (now - pick_started_at).total_seconds()
      - Handles null values (returns 0 if no timer configured or no pick started)
    - Updated draft_status endpoint in `FantasyF1_BE/app/api/v1/endpoints/drafts.py`:
      - Returns timer info in DraftStatusResponse
      - Includes time_remaining, is_paused, pick_started_at fields
  - Frontend implementation:
    - Created CountdownTimer component in `frontend/src/components/CountdownTimer.tsx`:
      - Displays minutes and seconds remaining
      - Auto-refreshes every second using setInterval
      - Visual warning when < 10 seconds: red color, pulse animation
      - Shows "Paused" when timer is paused
      - Shows "Time's up!" when timer expires
      - Cleans up interval on unmount
    - Updated DraftStatus.tsx to integrate CountdownTimer:
      - Displays timer prominently when it's user's turn
      - Passes timer info from draft_status API response
      - Timer shows in "Your Turn!" banner
    - Updated TypeScript types in `frontend/src/types/index.ts`:
      - Added TimerInfo interface with time_remaining, is_paused, pick_started_at
      - Updated DraftStatus interface to include timer_info
  - Fixed timezone consistency issues:
    - Changed from `datetime.now(UTC)` to `datetime.now(timezone.utc)` in notification_service.py
    - Changed from `from datetime import UTC` to `from datetime import datetime, timezone`
    - Updated test fixtures in test_notification_endpoints.py to use `timezone.utc`

- **Files changed:**
  - `FantasyF1_BE/alembic/versions/002_add_draft_timer_fields.py` - New migration
  - `FantasyF1_BE/app/models/league.py` - Added timer fields
  - `FantasyF1_BE/app/models/draft.py` - Added pick_started_at field
  - `FantasyF1_BE/app/services/draft_service.py` - Added get_timer_info method
  - `FantasyF1_BE/app/api/v1/endpoints/drafts.py` - Updated draft_status endpoint
  - `FantasyF1_BE/app/services/notification_service.py` - Fixed timezone imports
  - `FantasyF1_BE/tests/test_notification_endpoints.py` - Fixed timezone imports
  - `frontend/src/components/CountdownTimer.tsx` - New component
  - `frontend/src/pages/DraftStatus.tsx` - Integrated timer
  - `frontend/src/types/index.ts` - Added TimerInfo type

- **Quality checks:**
  - ✅ Black formatting passed
  - ✅ Ruff linting passed
  - ✅ MyPy type checking passed
  - ✅ Notification tests passed (18/18)
  - ✅ Commit successful: `feat: US-001 - Add draft timer functionality`
  - ✅ Updated prd.json to mark US-051 as passing

- **Learnings for future iterations:**
  - Timer pattern: Store config in League model, start time in DraftPick model, calculate remaining time in service
  - Timer calculation: remaining = configured_seconds - (now - start_time).total_seconds()
  - Frontend timer: Use setInterval with 1-second interval, cleanup on unmount
  - Visual warning: CSS animation (pulse) when time is low (< 10 seconds)
  - Pause functionality: Boolean flag in League model, timer stops when paused
  - Timer resets: Update pick_started_at when new pick starts
  - Use `timezone.utc` consistently instead of importing `UTC` from datetime module
  - Test fixtures need to use `datetime.now(timezone.utc)` for datetime values
  - Sound notification is optional and not implemented (muted by default)
  - Timer info should be included in draft_status API response for real-time updates

---

## 2/2/2026, 10:05 AM - US-050: Draft Auto-Pick Functionality
- **Implemented backend auto-pick support for draft picks:**
  - Added `auto` parameter to POST /api/v1/drafts/{league_id}/draft-picks endpoint:
    - Query parameter: `auto` (boolean, default: false)
    - Distinguishes between manual picks and auto-picks
  - Updated `make_draft_pick` service method in draft_service.py:
    - Added `is_auto` parameter (boolean, default: false)
    - Removed unused `user_id` parameter to fix lint error (ARG004)
    - Stores `is_auto_pick` flag in DraftPick model
  - Improved auto-pick strategy in `make_auto_pick` method:
    - Selects highest-ranked available driver by `total_points` (descending order)
    - Uses `order_by(Driver.total_points.desc()).limit(1)` for optimal selection
    - Handles both cases: with and without already-picked drivers
  - Added notification support for auto-picks:
    - Created `notify_auto_pick` method in NotificationService
    - Sends notification to team owner when auto-pick is made
    - Includes driver name, league name, and link to draft page
    - Uses `contextlib.suppress(Exception)` to prevent notification failures from breaking picks
  - Fixed timezone consistency issues:
    - Changed from `datetime.now(UTC)` to `datetime.now(timezone.utc)`
    - Updated imports from `from datetime import UTC` to `from datetime import datetime, timezone`
  - Fixed mypy error for SQLAlchemy Result.rowcount:
    - Added `# type: ignore[attr-defined]` comment

- **Files changed:**
  - `FantasyF1_BE/app/services/draft_service.py` - Added is_auto parameter, improved auto-pick strategy, added notification integration
  - `FantasyF1_BE/app/services/notification_service.py` - Added notify_auto_pick method, fixed timezone imports
  - `FantasyF1_BE/app/api/v1/endpoints/drafts.py` - Added auto query parameter to make_draft_pick endpoint

- **Quality checks:**
  - ✅ Black formatting passed
  - ✅ Ruff linting passed (all checks passed)
  - ✅ MyPy type checking passed
  - ✅ Commit successful: `feat: US-050 - Add auto-pick support for draft picks`
  - ✅ Updated prd.json to mark US-050 as passing

- **Learnings for future iterations:**
  - Auto-pick pattern: Timer expires → make_auto_pick called → selects highest-ranked driver → creates pick → sends notification
  - Use `contextlib.suppress(Exception)` for non-critical operations to prevent cascading failures
  - Remove unused parameters from service methods to avoid ARG004 lint errors
  - Use `timezone.utc` consistently instead of importing `UTC` from datetime module
  - SQLAlchemy Result.rowcount needs `# type: ignore[attr-defined]` for mypy
  - Auto-pick strategy should be intelligent (highest-ranked by total_points, not random)
  - Notification service should have dedicated methods for specific events (notify_auto_pick)
  - API endpoints should accept boolean flags to distinguish between manual and automated actions
  - Frontend user preferences page (US-058) and timer integration (US-051) are dependencies for full functionality

---

## 2/2/2026, 9:49 AM - US-049: User Search for Invitations
- **Implemented complete user search functionality for league invitations:**
  - Backend implementation:
    - Added `search_users()` service method in `FantasyF1_BE/app/services/user_service.py`
    - Method filters users by username (case-insensitive partial match)
    - Limits results to specified number (default 10)
    - Returns list of UserSearchResult with id, username, full_name, email
    - Raises NotFoundError if no users found
  - Added Pydantic schemas in `FantasyF1_BE/app/schemas/user.py`:
    - `UserSearchResult`: Individual user result with id, username, full_name, email
    - `UserSearchResponse`: Response wrapper with users list and total count
  - Added backend endpoint in `FantasyF1_BE/app/api/v1/endpoints/users.py`:
    - GET /api/v1/users/search?q={query}&limit={limit}
    - Query parameters: q (search query, min 2 chars), limit (max results, default 10)
    - Returns UserSearchResponse
  - Frontend implementation:
    - Added `searchUsers()` method in `frontend/src/services/userService.ts`
    - Returns Promise<UserSearchResult[]>
    - Error handling with user-friendly messages
    - Added UserSearchResult type to `frontend/src/types/index.ts`
  - Updated `frontend/src/pages/SendInvitations.tsx`:
    - Added search input in Username tab with debounced search (300ms)
    - Created `useDebounce` hook for search query debouncing
    - Added search results dropdown with username, full name, and email
    - Click-to-fill functionality: clicking result fills username field
    - Close dropdown when clicking outside (useRef + mousedown listener)
    - Loading spinner during search
    - Empty state when no results found
    - Search only triggers when query is 2+ characters
  - Added CSS styling in `frontend/src/App.css`:
    - `.search-input-container` for input with spinner positioning
    - `.search-spinner` for loading indicator
    - `.search-results-dropdown` for results list
    - `.search-result-item` for individual result with hover effects
    - `.search-result-info` for result content layout
    - `.search-result-username`, `.search-result-name`, `.search-result-email` for styling
    - `.search-result-empty` for no results message

- **Files changed:**
  - `FantasyF1_BE/app/services/user_service.py` - Added search_users method
  - `FantasyF1_BE/app/schemas/user.py` - Added UserSearchResult and UserSearchResponse schemas
  - `FantasyF1_BE/app/api/v1/endpoints/users.py` - Added GET /search endpoint
  - `frontend/src/services/userService.ts` - Added searchUsers method
  - `frontend/src/types/index.ts` - Added UserSearchResult type
  - `frontend/src/pages/SendInvitations.tsx` - Added search functionality with debouncing
  - `frontend/src/App.css` - Added CSS styling for search components

- **Quality checks:**
  - ✅ TypeScript check passed (npx tsc --noEmit)
  - ✅ Fixed lint error (removed unused useCallback import)
  - ✅ Commit successful: `feat: US-049 - Add user search functionality to SendInvitations page`
  - ✅ Updated prd.json to mark US-049 as passing

- **Learnings for future iterations:**
  - User search pattern: Debounced input (300ms) → API call → Dropdown results → Click to fill
  - Debounce hook: Custom hook with useState and useEffect, cleanup timeout on unmount
  - Click outside pattern: useRef for dropdown container, mousedown event listener, cleanup on unmount
  - Search results should show multiple fields (username, full name, email) for better identification
  - Empty state message should include the search query for context
  - Loading spinner positioned inside input container for better UX
  - Backend search should use case-insensitive partial matching (ilike in SQLAlchemy)
  - Limit results to reasonable number (10) to avoid overwhelming UI
  - Minimum query length (2 chars) prevents unnecessary API calls for short queries
  - TypeScript types should match backend response structure exactly

---

## 2/2/2026, 7:26 AM - US-046: Driver Performance History (Implementation Completed)
- **Completed implementation of backend and frontend for Driver Performance:**
  - Created backend endpoint `GET /api/v1/drivers/{driver_id}/performance`:
    - Returns DriverPerformanceResponse with driver info, statistics, and race results
    - Joins RaceResult with Race to get race details
    - Calculates statistics: total points, avg points, best/worst finish, podiums, DNFs
  - Created Pydantic schemas in driver.py:
    - DriverRaceResult: Individual race performance data
    - DriverPerformanceStats: Aggregated statistics
    - DriverPerformanceResponse: Combined response structure
  - Implemented get_driver_performance service method in driver_service.py:
    - Fetches all race results for driver joined with race data
    - Builds race results list with position, grid, points, DNF status
    - Calculates comprehensive statistics from race data
    - Raises NotFoundError if driver doesn't exist
  - Frontend already had full implementation:
    - Performance tab on DriverDetail.tsx with all features
    - Race-by-race performance table with all required columns
    - SVG bar chart showing points per race
    - Season statistics summary card

- **Files changed:**
  - `FantasyF1_BE/app/api/v1/endpoints/drivers.py` - Added GET /{id}/performance endpoint
  - `FantasyF1_BE/app/services/driver_service.py` - Added get_driver_performance method
  - `FantasyF1_BE/app/schemas/driver.py` - Added performance-related Pydantic schemas
  - `frontend/src/pages/DriverDetail.tsx` - Already had performance tab (verified)
  - `frontend/src/services/driverService.ts` - Already had getDriverPerformance (verified)
  - `frontend/src/types/index.ts` - Already had Driver performance types (verified)

- **Quality checks:**
  - ✅ TypeScript check passed (npx tsc --noEmit)
  - ✅ Black formatting passed
  - ✅ Ruff linting passed (all checks passed)
  - ✅ Commit successful: `feat: US-046 - Driver Performance History`
  - ✅ Updated prd.json to mark US-046 as passing

- **Learnings for future iterations:**
  - When joining tables in SQLAlchemy, use `select(ModelA, ModelB).join(...)` pattern
  - Calculate statistics by iterating over fetched results rather than multiple queries
  - SVG charts are lightweight alternative to heavy charting libraries
  - Position-based styling (gold/silver/bronze) provides immediate visual hierarchy
  - DNF status should be prominent with distinct red styling
  - NotFoundError expects dict for details parameter: `{"driver_id": driver_id}`

---

## 2/2/2026, 7:24 AM - US-